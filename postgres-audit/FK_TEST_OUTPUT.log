Timing is on.
\echo ''

\echo '========================================='
=========================================
\echo 'Testing All Foreign Key Indexes'
Testing All Foreign Key Indexes
\echo '========================================='
=========================================
\echo ''

\echo 'This will test index performance for 20+ foreign keys without indexes'
This will test index performance for 20+ foreign keys without indexes
\echo 'Each test runs 5 iterations baseline + 5 iterations with index'
Each test runs 5 iterations baseline + 5 iterations with index
\echo 'Indexes showing <5% improvement will be rolled back'
Indexes showing <5% improvement will be rolled back
\echo 'All test indexes will be cleaned up at the end'
All test indexes will be cleaned up at the end
\echo ''

-- Create logging table if it doesn't exist
CREATE TABLE IF NOT EXISTS pg_index_test_log (
    test_id SERIAL PRIMARY KEY,
    test_timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    table_name TEXT,
    index_name TEXT,
    test_phase TEXT,
    execution_time_ms NUMERIC,
    query_plan TEXT,
    decision TEXT,
    improvement_percent NUMERIC,
    notes TEXT
);
psql:/tmp/test_all_foreign_keys.sql:32: NOTICE:  relation "pg_index_test_log" already exists, skipping
CREATE TABLE
Time: 4.125 ms
\echo 'Created/verified pg_index_test_log table'
Created/verified pg_index_test_log table
\echo ''

-- ============================================================================
-- FUNCTION: Test Query Performance
-- ============================================================================
CREATE OR REPLACE FUNCTION test_query_performance(
    p_table_name TEXT,
    p_query TEXT,
    p_iterations INT DEFAULT 5
)
RETURNS NUMERIC AS $$
DECLARE
    v_start TIMESTAMP;
    v_end TIMESTAMP;
    v_total_ms NUMERIC := 0;
    v_avg_ms NUMERIC;
    i INT;
BEGIN
    -- Warm up (discard first run)
    EXECUTE p_query;

    -- Run multiple iterations
    FOR i IN 1..p_iterations LOOP
        v_start := clock_timestamp();
        EXECUTE p_query;
        v_end := clock_timestamp();
        v_total_ms := v_total_ms + EXTRACT(MILLISECOND FROM (v_end - v_start));
    END LOOP;

    v_avg_ms := v_total_ms / p_iterations;
    RETURN v_avg_ms;
END;
$$ LANGUAGE plpgsql;
CREATE FUNCTION
Time: 11.555 ms
\echo 'Created function: test_query_performance()'
Created function: test_query_performance()
\echo ''

-- ============================================================================
-- FUNCTION: Test Index Candidate
-- ============================================================================
CREATE OR REPLACE FUNCTION test_index_candidate(
    p_table_name TEXT,
    p_index_name TEXT,
    p_index_definition TEXT,
    p_test_query TEXT,
    p_improvement_threshold NUMERIC DEFAULT 5.0
)
RETURNS TABLE (
    decision TEXT,
    baseline_ms NUMERIC,
    with_index_ms NUMERIC,
    improvement_percent NUMERIC,
    recommendation TEXT
) AS $$
DECLARE
    v_baseline_ms NUMERIC;
    v_with_index_ms NUMERIC;
    v_improvement_percent NUMERIC;
    v_decision TEXT;
    v_recommendation TEXT;
    v_baseline_plan TEXT;
    v_index_plan TEXT;
BEGIN
    -- Step 1: Test baseline (without index)
    RAISE NOTICE 'Testing baseline performance for %...', p_table_name;
    v_baseline_ms := test_query_performance(p_table_name, p_test_query, 5);
    RAISE NOTICE 'Baseline: %.2f ms (avg of 5 runs)', v_baseline_ms;

    -- Get baseline query plan
    EXECUTE 'EXPLAIN (FORMAT TEXT) ' || p_test_query INTO v_baseline_plan;

    -- Log baseline
    INSERT INTO pg_index_test_log (
        table_name, index_name, test_phase, execution_time_ms, query_plan, notes
    ) VALUES (
        p_table_name, p_index_name, 'baseline', v_baseline_ms, v_baseline_plan,
        'Baseline test without index'
    );

    -- Step 2: Create index
    RAISE NOTICE 'Creating index: %', p_index_name;
    BEGIN
        EXECUTE p_index_definition;
        RAISE NOTICE 'Index created successfully';
    EXCEPTION WHEN OTHERS THEN
        RAISE NOTICE 'Failed to create index: %', SQLERRM;
        v_decision := 'error';
        v_recommendation := 'Failed to create index: ' || SQLERRM;
        RETURN QUERY SELECT v_decision, v_baseline_ms, NULL::NUMERIC, NULL::NUMERIC, v_recommendation;
        RETURN;
    END;

    -- Update statistics
    EXECUTE 'ANALYZE ' || p_table_name;

    -- Step 3: Test with index
    RAISE NOTICE 'Testing performance with index...';
    v_with_index_ms := test_query_performance(p_table_name, p_test_query, 5);
    RAISE NOTICE 'With index: %.2f ms (avg of 5 runs)', v_with_index_ms;

    -- Get index query plan
    EXECUTE 'EXPLAIN (FORMAT TEXT) ' || p_test_query INTO v_index_plan;

    -- Log with-index test
    INSERT INTO pg_index_test_log (
        table_name, index_name, test_phase, execution_time_ms, query_plan, notes
    ) VALUES (
        p_table_name, p_index_name, 'with_index', v_with_index_ms, v_index_plan,
        'Test with index created'
    );

    -- Step 4: Calculate improvement
    v_improvement_percent := ROUND(
        100.0 * (v_baseline_ms - v_with_index_ms) / NULLIF(v_baseline_ms, 0),
        2
    );

    -- Step 5: Make decision
    IF v_improvement_percent >= p_improvement_threshold THEN
        v_decision := 'KEEP';
        v_recommendation := FORMAT(
            'Index improved performance by %s%% (%.2fms -> %.2fms). KEEPING index.',
            v_improvement_percent, v_baseline_ms, v_with_index_ms
        );
        RAISE NOTICE '%', v_recommendation;
    ELSE
        v_decision := 'ROLLBACK';
        v_recommendation := FORMAT(
            'Index only improved by %s%% (%.2fms -> %.2fms). ROLLING BACK.',
            COALESCE(v_improvement_percent, 0), v_baseline_ms, v_with_index_ms
        );
        RAISE NOTICE '%', v_recommendation;

        -- Drop the index
        EXECUTE 'DROP INDEX IF EXISTS ' || p_index_name;
        RAISE NOTICE 'Index dropped';
    END IF;

    -- Log decision
    INSERT INTO pg_index_test_log (
        table_name, index_name, test_phase, execution_time_ms,
        decision, improvement_percent, notes
    ) VALUES (
        p_table_name, p_index_name, 'decision', v_with_index_ms,
        v_decision, v_improvement_percent, v_recommendation
    );

    -- Return results
    RETURN QUERY SELECT
        v_decision,
        v_baseline_ms,
        v_with_index_ms,
        v_improvement_percent,
        v_recommendation;
END;
$$ LANGUAGE plpgsql;
CREATE FUNCTION
Time: 2.994 ms
\echo 'Created function: test_index_candidate()'
Created function: test_index_candidate()
\echo ''

-- ============================================================================
-- AUTOMATED TEST SUITE: Test All Foreign Key Indexes
-- ============================================================================
\echo ''

\echo '--- Running Automated Test Suite for All Foreign Keys ---'
--- Running Automated Test Suite for All Foreign Keys ---
\echo ''

DO $$
DECLARE
    fk_rec RECORD;
    test_result RECORD;
    test_query TEXT;
    index_name TEXT;
    index_def TEXT;
    test_count INT := 0;
BEGIN
    -- Loop through foreign keys without indexes (top 20 by size)
    FOR fk_rec IN
        SELECT DISTINCT
            c.conrelid::regclass::text AS table_name,
            a.attname AS column_name,
            c.confrelid::regclass::text AS ref_table,
            pg_size_pretty(pg_relation_size(c.conrelid)) AS table_size,
            (SELECT reltuples::bigint FROM pg_class WHERE oid = c.conrelid) AS row_count,
            pg_relation_size(c.conrelid) AS size_bytes
        FROM pg_constraint c
        JOIN pg_attribute a ON a.attnum = ANY(c.conkey) AND a.attrelid = c.conrelid
        WHERE c.contype = 'f'
          AND NOT EXISTS (
              SELECT 1
              FROM pg_index i
              WHERE i.indrelid = c.conrelid
                AND c.conkey[1] = ANY(i.indkey)
          )
        ORDER BY size_bytes DESC
        LIMIT 20
    LOOP
        test_count := test_count + 1;

        -- Generate index name and definition
        index_name := 'idx_test_fk_' || replace(replace(fk_rec.table_name, '.', '_'), 'public.', '') || '_' || fk_rec.column_name;
        index_def := FORMAT('CREATE INDEX %s ON %s(%s)', index_name, fk_rec.table_name, fk_rec.column_name);

        -- Generate test query (JOIN to referenced table - typical FK use case)
        test_query := FORMAT(
            'SELECT COUNT(*) FROM %s t JOIN %s r ON t.%s = r.%s LIMIT 1000',
            fk_rec.table_name,
            fk_rec.ref_table,
            fk_rec.column_name,
            -- Assume referenced table primary key is 'id' or table_name + '_id'
            CASE
                WHEN EXISTS (
                    SELECT 1 FROM pg_attribute
                    WHERE attrelid = (fk_rec.ref_table)::regclass
                    AND attname = 'id'
                ) THEN 'id'
                ELSE (SELECT attname FROM pg_attribute
                      WHERE attrelid = (fk_rec.ref_table)::regclass
                      AND attnum = 1
                      LIMIT 1)
            END
        );

        RAISE NOTICE '';
        RAISE NOTICE '========================================';
        RAISE NOTICE 'Test %/20: % ON %(%)', test_count, index_name, fk_rec.table_name, fk_rec.column_name;
        RAISE NOTICE 'Table size: % | Rows: % | References: %', fk_rec.table_size, fk_rec.row_count, fk_rec.ref_table;
        RAISE NOTICE '========================================';

        -- Test the index
        BEGIN
            SELECT * INTO test_result
            FROM test_index_candidate(
                fk_rec.table_name,
                index_name,
                index_def,
                test_query,
                5.0  -- 5% minimum improvement
            );

            -- Log result
            RAISE NOTICE 'Result: %', test_result.recommendation;
        EXCEPTION WHEN OTHERS THEN
            RAISE NOTICE 'ERROR testing %: %', index_name, SQLERRM;
            INSERT INTO pg_index_test_log (
                table_name, index_name, test_phase, decision, notes
            ) VALUES (
                fk_rec.table_name, index_name, 'error', 'ERROR',
                'Test failed: ' || SQLERRM
            );
        END;
    END LOOP;

    RAISE NOTICE '';
    RAISE NOTICE 'Completed % tests', test_count;
END $$;
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Test 1/20: idx_test_fk_xhbm_container_entity_history_container_entity ON xhbm_container_entity_history(container_entity)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Table size: 12 MB | Rows: 96133 | References: xhbm_container_entity
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing baseline performance for xhbm_container_entity_history...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Baseline: 22.5096000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Creating index: idx_test_fk_xhbm_container_entity_history_container_entity
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Index created successfully
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing performance with index...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  With index: 17.4890000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ERROR testing idx_test_fk_xhbm_container_entity_history_container_entity: unrecognized format() type specifier "."
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Test 2/20: idx_test_fk_xhbm_container_entity_parent_container_entity ON xhbm_container_entity(parent_container_entity)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Table size: 5824 kB | Rows: 14682 | References: xhbm_container_entity
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing baseline performance for xhbm_container_entity...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Baseline: 6.6924000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Creating index: idx_test_fk_xhbm_container_entity_parent_container_entity
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Index created successfully
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing performance with index...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  With index: 0.31760000000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ERROR testing idx_test_fk_xhbm_container_entity_parent_container_entity: unrecognized format() type specifier "."
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Test 3/20: idx_test_fk_xhbm_container_entity_mount_container_entity ON xhbm_container_entity_mount(container_entity)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Table size: 4952 kB | Rows: 27953 | References: xhbm_container_entity
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing baseline performance for xhbm_container_entity_mount...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Baseline: 13.0476000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Creating index: idx_test_fk_xhbm_container_entity_mount_container_entity
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Index created successfully
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing performance with index...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  With index: 8.5042000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ERROR testing idx_test_fk_xhbm_container_entity_mount_container_entity: unrecognized format() type specifier "."
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Test 4/20: idx_test_fk_xhbm_container_entity_output_container_entity ON xhbm_container_entity_output(container_entity)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Table size: 2392 kB | Rows: 16326 | References: xhbm_container_entity
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing baseline performance for xhbm_container_entity_output...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Baseline: 6.7916000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Creating index: idx_test_fk_xhbm_container_entity_output_container_entity
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Index created successfully
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing performance with index...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  With index: 5.8452000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ERROR testing idx_test_fk_xhbm_container_entity_output_container_entity: unrecognized format() type specifier "."
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Test 5/20: idx_test_fk_xhbm_container_entity_log_paths_container_entity ON xhbm_container_entity_log_paths(container_entity)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Table size: 1856 kB | Rows: 18178 | References: xhbm_container_entity
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing baseline performance for xhbm_container_entity_log_paths...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Baseline: 6.3128000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Creating index: idx_test_fk_xhbm_container_entity_log_paths_container_entity
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Index created successfully
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing performance with index...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  With index: 6.2890000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ERROR testing idx_test_fk_xhbm_container_entity_log_paths_container_entity: unrecognized format() type specifier "."
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Test 6/20: idx_test_fk_xhbm_timed_event_status_entity_subscription_delivery_entity ON xhbm_timed_event_status_entity(subscription_delivery_entity)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Table size: 488 kB | Rows: 6412 | References: xhbm_subscription_delivery_entity
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing baseline performance for xhbm_timed_event_status_entity...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Baseline: 1.6988000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Creating index: idx_test_fk_xhbm_timed_event_status_entity_subscription_delivery_entity
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  identifier "idx_test_fk_xhbm_timed_event_status_entity_subscription_delivery_entity" will be truncated to "idx_test_fk_xhbm_timed_event_status_entity_subscription_deliver"
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Index created successfully
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing performance with index...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  With index: 1.5730000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ERROR testing idx_test_fk_xhbm_timed_event_status_entity_subscription_delivery_entity: unrecognized format() type specifier "."
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Test 7/20: idx_test_fk_xhbm_subscription_delivery_entity_subscription ON xhbm_subscription_delivery_entity(subscription)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Table size: 288 kB | Rows: 916 | References: xhbm_subscription_entity
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing baseline performance for xhbm_subscription_delivery_entity...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Baseline: 0.47400000000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Creating index: idx_test_fk_xhbm_subscription_delivery_entity_subscription
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Index created successfully
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing performance with index...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  With index: 0.47080000000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ERROR testing idx_test_fk_xhbm_subscription_delivery_entity_subscription: unrecognized format() type specifier "."
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Test 8/20: idx_test_fk_xhbm_subscription_delivery_entity_triggering_event_entity ON xhbm_subscription_delivery_entity(triggering_event_entity)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Table size: 288 kB | Rows: 916 | References: xhbm_triggering_event_entity
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing baseline performance for xhbm_subscription_delivery_entity...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Baseline: 0.75440000000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Creating index: idx_test_fk_xhbm_subscription_delivery_entity_triggering_event_entity
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  identifier "idx_test_fk_xhbm_subscription_delivery_entity_triggering_event_entity" will be truncated to "idx_test_fk_xhbm_subscription_delivery_entity_triggering_event_"
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Index created successfully
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing performance with index...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  With index: 0.96760000000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ERROR testing idx_test_fk_xhbm_subscription_delivery_entity_triggering_event_entity: unrecognized format() type specifier "."
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Test 9/20: idx_test_fk_xnat_experimentdata_visit ON xnat_experimentdata(visit)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Table size: 272 kB | Rows: 2533 | References: xnat_pvisitdata
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing baseline performance for xnat_experimentdata...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Baseline: 0.29380000000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Creating index: idx_test_fk_xnat_experimentdata_visit
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Index created successfully
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing performance with index...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  With index: 0.32260000000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ERROR testing idx_test_fk_xnat_experimentdata_visit: unrecognized format() type specifier "."
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Test 10/20: idx_test_fk_xhbm_automation_event_ids_ids_parent_automation_event_ids ON xhbm_automation_event_ids_ids(parent_automation_event_ids)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Table size: 216 kB | Rows: 1818 | References: xhbm_automation_event_ids
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing baseline performance for xhbm_automation_event_ids_ids...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Baseline: 0.70220000000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Creating index: idx_test_fk_xhbm_automation_event_ids_ids_parent_automation_event_ids
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  identifier "idx_test_fk_xhbm_automation_event_ids_ids_parent_automation_event_ids" will be truncated to "idx_test_fk_xhbm_automation_event_ids_ids_parent_automation_eve"
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Index created successfully
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing performance with index...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  With index: 0.74140000000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ERROR testing idx_test_fk_xhbm_automation_event_ids_ids_parent_automation_event_ids: unrecognized format() type specifier "."
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Test 11/20: idx_test_fk_icr_roicollectiondata_subjectid ON icr_roicollectiondata(subjectid)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Table size: 160 kB | Rows: 557 | References: xnat_subjectdata
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing baseline performance for icr_roicollectiondata...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Baseline: 1.3488000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Creating index: idx_test_fk_icr_roicollectiondata_subjectid
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Index created successfully
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing performance with index...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  With index: 0.99800000000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ERROR testing idx_test_fk_icr_roicollectiondata_subjectid: unrecognized format() type specifier "."
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Test 12/20: idx_test_fk_xhbm_configuration_config_data ON xhbm_configuration(config_data)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Table size: 160 kB | Rows: 653 | References: xhbm_configuration_data
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing baseline performance for xhbm_configuration...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Baseline: 0.96600000000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Creating index: idx_test_fk_xhbm_configuration_config_data
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Index created successfully
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing performance with index...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  With index: 1.16300000000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ERROR testing idx_test_fk_xhbm_configuration_config_data: unrecognized format() type specifier "."
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Test 13/20: idx_test_fk_xnat_subjectassessordata_subject_id ON xnat_subjectassessordata(subject_id)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Table size: 120 kB | Rows: 1974 | References: xnat_subjectdata
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing baseline performance for xnat_subjectassessordata...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Baseline: 1.8056000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Creating index: idx_test_fk_xnat_subjectassessordata_subject_id
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Index created successfully
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing performance with index...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  With index: 1.4704000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ERROR testing idx_test_fk_xnat_subjectassessordata_subject_id: unrecognized format() type specifier "."
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Test 14/20: idx_test_fk_xhbm_event_service_filter_entity_project_ids_event_service_filter_entity ON xhbm_event_service_filter_entity_project_ids(event_service_filter_entity)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Table size: 112 kB | Rows: 2051 | References: xhbm_event_service_filter_entity
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing baseline performance for xhbm_event_service_filter_entity_project_ids...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Baseline: 1.3274000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Creating index: idx_test_fk_xhbm_event_service_filter_entity_project_ids_event_service_filter_entity
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  identifier "idx_test_fk_xhbm_event_service_filter_entity_project_ids_event_service_filter_entity" will be truncated to "idx_test_fk_xhbm_event_service_filter_entity_project_ids_event_"
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Index created successfully
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing performance with index...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  With index: 1.2470000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ERROR testing idx_test_fk_xhbm_event_service_filter_entity_project_ids_event_service_filter_entity: unrecognized format() type specifier "."
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Test 15/20: idx_test_fk_xnat_experimentdata_resource_xnat_abstractresource_xnat_abstractresource_id ON xnat_experimentdata_resource(xnat_abstractresource_xnat_abstractresource_id)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Table size: 104 kB | Rows: 1894 | References: xnat_abstractresource
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing baseline performance for xnat_experimentdata_resource...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ERROR testing idx_test_fk_xnat_experimentdata_resource_xnat_abstractresource_xnat_abstractresource_id: operator does not exist: integer = text
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Test 16/20: idx_test_fk_xnat_experimentdata_resource_xnat_experimentdata_id ON xnat_experimentdata_resource(xnat_experimentdata_id)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Table size: 104 kB | Rows: 1894 | References: xnat_experimentdata
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing baseline performance for xnat_experimentdata_resource...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Baseline: 1.5200000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Creating index: idx_test_fk_xnat_experimentdata_resource_xnat_experimentdata_id
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Index created successfully
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing performance with index...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  With index: 1.5530000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ERROR testing idx_test_fk_xnat_experimentdata_resource_xnat_experimentdata_id: unrecognized format() type specifier "."
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Test 17/20: idx_test_fk_img_assessor_out_resource_xnat_abstractresource_xnat_abstractresource_id ON img_assessor_out_resource(xnat_abstractresource_xnat_abstractresource_id)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Table size: 72 kB | Rows: 1107 | References: xnat_abstractresource
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing baseline performance for img_assessor_out_resource...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ERROR testing idx_test_fk_img_assessor_out_resource_xnat_abstractresource_xnat_abstractresource_id: operator does not exist: integer = text
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Test 18/20: idx_test_fk_img_assessor_out_resource_xnat_imageassessordata_id ON img_assessor_out_resource(xnat_imageassessordata_id)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Table size: 72 kB | Rows: 1107 | References: xnat_imageassessordata
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing baseline performance for img_assessor_out_resource...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Baseline: 0.82080000000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Creating index: idx_test_fk_img_assessor_out_resource_xnat_imageassessordata_id
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Index created successfully
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing performance with index...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  With index: 1.02480000000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ERROR testing idx_test_fk_img_assessor_out_resource_xnat_imageassessordata_id: unrecognized format() type specifier "."
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Test 19/20: idx_test_fk_xnat_imageassessordata_imagesession_id ON xnat_imageassessordata(imagesession_id)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Table size: 40 kB | Rows: 559 | References: xnat_imagesessiondata
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing baseline performance for xnat_imageassessordata...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Baseline: 1.03340000000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Creating index: idx_test_fk_xnat_imageassessordata_imagesession_id
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Index created successfully
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing performance with index...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  With index: 1.05320000000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ERROR testing idx_test_fk_xnat_imageassessordata_imagesession_id: unrecognized format() type specifier "."
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Test 20/20: idx_test_fk_xhbm_automation_filters_values_automation_filters ON xhbm_automation_filters_values(automation_filters)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Table size: 16 kB | Rows: 290 | References: xhbm_automation_filters
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ========================================
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing baseline performance for xhbm_automation_filters_values...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Baseline: 0.28520000000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Creating index: idx_test_fk_xhbm_automation_filters_values_automation_filters
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Index created successfully
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Testing performance with index...
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  With index: 0.29160000000000000000.2f ms (avg of 5 runs)
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  ERROR testing idx_test_fk_xhbm_automation_filters_values_automation_filters: unrecognized format() type specifier "."
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  
psql:/tmp/test_all_foreign_keys.sql:293: NOTICE:  Completed 20 tests
DO
Time: 2589.307 ms (00:02.589)
-- ============================================================================
-- GENERATE FINAL REPORT
-- ============================================================================
\echo ''

\echo '========================================='
=========================================
\echo 'FINAL PERFORMANCE TEST REPORT'
FINAL PERFORMANCE TEST REPORT
\echo '========================================='
=========================================
\echo ''

\echo '--- Summary Statistics ---'
--- Summary Statistics ---
SELECT
    COUNT(DISTINCT table_name) AS tables_tested,
    COUNT(DISTINCT index_name) AS indexes_tested,
    COUNT(*) FILTER (WHERE decision = 'KEEP') AS indexes_kept,
    COUNT(*) FILTER (WHERE decision = 'ROLLBACK') AS indexes_rolled_back,
    COUNT(*) FILTER (WHERE decision = 'ERROR') AS errors,
    ROUND(AVG(improvement_percent) FILTER (WHERE decision = 'KEEP'), 2) AS avg_improvement_percent
FROM pg_index_test_log
WHERE test_phase = 'decision';
 tables_tested | indexes_tested | indexes_kept | indexes_rolled_back | errors | avg_improvement_percent 
---------------+----------------+--------------+---------------------+--------+-------------------------
             0 |              0 |            0 |                   0 |      0 |                        
(1 row)

Time: 3.309 ms
\echo ''

\echo '--- Kept Indexes (Performance Improved >= 5%) ---'
--- Kept Indexes (Performance Improved >= 5%) ---
SELECT
    table_name,
    index_name,
    ROUND(improvement_percent, 2) AS improvement_pct,
    LEFT(notes, 80) AS notes
FROM pg_index_test_log
WHERE test_phase = 'decision'
  AND decision = 'KEEP'
ORDER BY improvement_percent DESC;
 table_name | index_name | improvement_pct | notes 
------------+------------+-----------------+-------
(0 rows)

Time: 2.537 ms
\echo ''

\echo '--- Rolled Back Indexes (Improvement < 5%) ---'
--- Rolled Back Indexes (Improvement < 5%) ---
SELECT
    table_name,
    index_name,
    ROUND(COALESCE(improvement_percent, 0), 2) AS improvement_pct,
    LEFT(notes, 80) AS notes
FROM pg_index_test_log
WHERE test_phase = 'decision'
  AND decision = 'ROLLBACK'
ORDER BY improvement_percent DESC NULLS LAST;
 table_name | index_name | improvement_pct | notes 
------------+------------+-----------------+-------
(0 rows)

Time: 17.053 ms
\echo ''

\echo '--- Errors ---'
--- Errors ---
SELECT
    table_name,
    index_name,
    notes
FROM pg_index_test_log
WHERE test_phase = 'error' OR decision = 'ERROR';
                  table_name                  |                                       index_name                                        |                         notes                         
----------------------------------------------+-----------------------------------------------------------------------------------------+-------------------------------------------------------
 xhbm_container_entity_history                | idx_test_fk_xhbm_container_entity_history_container_entity                              | Test failed: unrecognized format() type specifier "."
 xhbm_container_entity                        | idx_test_fk_xhbm_container_entity_parent_container_entity                               | Test failed: unrecognized format() type specifier "."
 xhbm_container_entity_mount                  | idx_test_fk_xhbm_container_entity_mount_container_entity                                | Test failed: unrecognized format() type specifier "."
 xhbm_container_entity_output                 | idx_test_fk_xhbm_container_entity_output_container_entity                               | Test failed: unrecognized format() type specifier "."
 xhbm_container_entity_log_paths              | idx_test_fk_xhbm_container_entity_log_paths_container_entity                            | Test failed: unrecognized format() type specifier "."
 xhbm_timed_event_status_entity               | idx_test_fk_xhbm_timed_event_status_entity_subscription_delivery_entity                 | Test failed: unrecognized format() type specifier "."
 xhbm_subscription_delivery_entity            | idx_test_fk_xhbm_subscription_delivery_entity_subscription                              | Test failed: unrecognized format() type specifier "."
 xhbm_subscription_delivery_entity            | idx_test_fk_xhbm_subscription_delivery_entity_triggering_event_entity                   | Test failed: unrecognized format() type specifier "."
 xnat_experimentdata                          | idx_test_fk_xnat_experimentdata_visit                                                   | Test failed: unrecognized format() type specifier "."
 xhbm_automation_event_ids_ids                | idx_test_fk_xhbm_automation_event_ids_ids_parent_automation_event_ids                   | Test failed: unrecognized format() type specifier "."
 icr_roicollectiondata                        | idx_test_fk_icr_roicollectiondata_subjectid                                             | Test failed: unrecognized format() type specifier "."
 xhbm_configuration                           | idx_test_fk_xhbm_configuration_config_data                                              | Test failed: unrecognized format() type specifier "."
 xnat_subjectassessordata                     | idx_test_fk_xnat_subjectassessordata_subject_id                                         | Test failed: unrecognized format() type specifier "."
 xhbm_event_service_filter_entity_project_ids | idx_test_fk_xhbm_event_service_filter_entity_project_ids_event_service_filter_entity    | Test failed: unrecognized format() type specifier "."
 xnat_experimentdata_resource                 | idx_test_fk_xnat_experimentdata_resource_xnat_abstractresource_xnat_abstractresource_id | Test failed: operator does not exist: integer = text
 xnat_experimentdata_resource                 | idx_test_fk_xnat_experimentdata_resource_xnat_experimentdata_id                         | Test failed: unrecognized format() type specifier "."
 img_assessor_out_resource                    | idx_test_fk_img_assessor_out_resource_xnat_abstractresource_xnat_abstractresource_id    | Test failed: operator does not exist: integer = text
 img_assessor_out_resource                    | idx_test_fk_img_assessor_out_resource_xnat_imageassessordata_id                         | Test failed: unrecognized format() type specifier "."
 xnat_imageassessordata                       | idx_test_fk_xnat_imageassessordata_imagesession_id                                      | Test failed: unrecognized format() type specifier "."
 xhbm_automation_filters_values               | idx_test_fk_xhbm_automation_filters_values_automation_filters                           | Test failed: unrecognized format() type specifier "."
(20 rows)

Time: 3.128 ms
\echo ''

\echo '--- Performance Comparison Details ---'
--- Performance Comparison Details ---
SELECT
    l.table_name,
    l.index_name,
    ROUND(b.execution_time_ms, 2) AS baseline_ms,
    ROUND(i.execution_time_ms, 2) AS with_index_ms,
    ROUND(l.improvement_percent, 2) AS improvement_pct,
    l.decision
FROM pg_index_test_log l
LEFT JOIN pg_index_test_log b
    ON l.table_name = b.table_name
    AND l.index_name = b.index_name
    AND b.test_phase = 'baseline'
LEFT JOIN pg_index_test_log i
    ON l.table_name = i.table_name
    AND l.index_name = i.index_name
    AND i.test_phase = 'with_index'
WHERE l.test_phase = 'decision'
ORDER BY l.improvement_percent DESC NULLS LAST;
 table_name | index_name | baseline_ms | with_index_ms | improvement_pct | decision 
------------+------------+-------------+---------------+-----------------+----------
(0 rows)

Time: 1.519 ms
-- ============================================================================
-- CLEANUP: Revert All Test Changes
-- ============================================================================
\echo ''

\echo '--- Cleanup: Reverting All Test Changes ---'
--- Cleanup: Reverting All Test Changes ---
\echo ''

-- Drop any remaining test indexes
DO $$
DECLARE
    idx_rec RECORD;
BEGIN
    FOR idx_rec IN
        SELECT DISTINCT indexname
        FROM pg_indexes
        WHERE indexname LIKE 'idx_test_fk_%'
    LOOP
        EXECUTE 'DROP INDEX IF EXISTS ' || idx_rec.indexname;
        RAISE NOTICE 'Dropped test index: %', idx_rec.indexname;
    END LOOP;
END $$;
DO
Time: 15.213 ms
-- Drop test functions
DROP FUNCTION IF EXISTS test_index_candidate(TEXT, TEXT, TEXT, TEXT, NUMERIC);
DROP FUNCTION
Time: 4.103 ms
DROP FUNCTION IF EXISTS test_query_performance(TEXT, TEXT, INT);
DROP FUNCTION
Time: 3.310 ms
\echo ''

\echo 'Test functions dropped'
Test functions dropped
\echo ''

-- Keep log table for review
\echo ''

\echo 'NOTE: Keeping pg_index_test_log table for review'
NOTE: Keeping pg_index_test_log table for review
\echo 'To view full test log: SELECT * FROM pg_index_test_log ORDER BY test_id;'
To view full test log: SELECT * FROM pg_index_test_log ORDER BY test_id;
\echo 'To drop log table: DROP TABLE pg_index_test_log;'
To drop log table: DROP TABLE pg_index_test_log;
\echo ''

-- ============================================================================
-- FINAL SUMMARY
-- ============================================================================
\echo '========================================='
=========================================
\echo 'AUTOMATED INDEX TESTING COMPLETE'
AUTOMATED INDEX TESTING COMPLETE
\echo '========================================='
=========================================
\echo ''

\echo 'Summary:'
Summary:
\echo '- All test indexes have been reverted'
- All test indexes have been reverted
\echo '- Test log preserved in pg_index_test_log table'
- Test log preserved in pg_index_test_log table
\echo '- Review report above for recommendations'
- Review report above for recommendations
\echo ''

\echo 'Next Steps:'
Next Steps:
\echo '1. Review indexes that were KEPT (showed >= 5% improvement)'
1. Review indexes that were KEPT (showed >= 5% improvement)
\echo '2. Manually create those indexes in production'
2. Manually create those indexes in production
\echo '3. Monitor performance after implementation'
3. Monitor performance after implementation
\echo ''

\echo 'To export full report:'
To export full report:
\echo '\\copy (SELECT * FROM pg_index_test_log ORDER BY test_id) TO ''fk_index_test_report.csv'' CSV HEADER'
\copy (SELECT * FROM pg_index_test_log ORDER BY test_id) TO 'fk_index_test_report.csv' CSV HEADER
\echo ''

