Timing is on.

=========================================
Testing Schema-Based Index Recommendations
=========================================

This will test 15 high-priority indexes based on schema analysis

TRUNCATE TABLE
Time: 17.000 ms
CREATE FUNCTION
Time: 4.294 ms
Test function created


=========================================
Test 1: xdat_change_info - change_date
=========================================
Audit logs queried by date range

psql:/tmp/test_schema_indexes.sql:127: NOTICE:  Baseline: 43.7650000000000000.2f ms
psql:/tmp/test_schema_indexes.sql:127: NOTICE:  Index created: idx_test_change_info_date
psql:/tmp/test_schema_indexes.sql:127: NOTICE:  With index: 0.40860000000000000000.2f ms
psql:/tmp/test_schema_indexes.sql:127: NOTICE:  KEEP - improved by 99.07.2f%
DO
Time: 780.647 ms

=========================================
Test 2: xhbm_container_entity_log_paths
=========================================
⚠️ CRITICAL: This table has NO indexes!

psql:/tmp/test_schema_indexes.sql:158: NOTICE:  Baseline: 1.06060000000000000000.2f ms
psql:/tmp/test_schema_indexes.sql:158: NOTICE:  Index created: idx_test_log_paths_container
psql:/tmp/test_schema_indexes.sql:158: NOTICE:  With index: 0.28800000000000000000.2f ms
psql:/tmp/test_schema_indexes.sql:158: NOTICE:  KEEP - improved by 72.85.2f%
DO
Time: 81.701 ms

=========================================
Test 3: xhbm_dicom_spatial_data - frame_number
=========================================
DICOM viewer frame navigation

Time: 2.034 ms

=========================================
Test 4: xhbm_dicom_spatial_data - series_uid
=========================================
DICOM series retrieval

psql:/tmp/test_schema_indexes.sql:182: ERROR:  argument of NOT must be type boolean, not type timestamp without time zone
LINE 1: ...l_data WHERE frame_number BETWEEN 1 AND 100 AND NOT disabled
                                                               ^
QUERY:  SELECT * FROM xhbm_dicom_spatial_data WHERE frame_number BETWEEN 1 AND 100 AND NOT disabled
CONTEXT:  PL/pgSQL function test_schema_index(text,text,text,text,text) line 22 at EXECUTE
SQL statement "SELECT *             FROM test_schema_index(
        'xhbm_dicom_spatial_data',
        'frame_number',
        'idx_test_dicom_frame',
        'SELECT * FROM xhbm_dicom_spatial_data WHERE frame_number BETWEEN 1 AND 100 AND NOT disabled',
        'NOT disabled'
    )"
PL/pgSQL function inline_code_block line 5 at SQL statement
psql:/tmp/test_schema_indexes.sql:214: NOTICE:  Baseline: 4.2774000000000000.2f ms
psql:/tmp/test_schema_indexes.sql:214: NOTICE:  Index created: idx_test_dicom_series
psql:/tmp/test_schema_indexes.sql:214: NOTICE:  With index: 0.54900000000000000000.2f ms
psql:/tmp/test_schema_indexes.sql:214: NOTICE:  KEEP - improved by 87.17.2f%
DO
Time: 486.945 ms

=========================================
Test 5: xhbm_container_entity - status, status_time
=========================================
Container status monitoring

Time: 2.524 ms

=========================================
Test 6: xhbm_container_entity - project, created
=========================================
Project-based container queries

psql:/tmp/test_schema_indexes.sql:238: ERROR:  argument of NOT must be type boolean, not type timestamp without time zone
LINE 1: ...ity WHERE status IN ('Running', 'Failed') AND NOT disabled O...
                                                             ^
QUERY:  SELECT * FROM xhbm_container_entity WHERE status IN ('Running', 'Failed') AND NOT disabled ORDER BY status_time DESC LIMIT 50
CONTEXT:  PL/pgSQL function test_schema_index(text,text,text,text,text) line 22 at EXECUTE
SQL statement "SELECT *             FROM test_schema_index(
        'xhbm_container_entity',
        'status, status_time DESC',
        'idx_test_container_status',
        'SELECT * FROM xhbm_container_entity WHERE status IN (''Running'', ''Failed'') AND NOT disabled ORDER BY status_time DESC LIMIT 50',
        'NOT disabled'
    )"
PL/pgSQL function inline_code_block line 5 at SQL statement
Time: 2.928 ms

=========================================
Test 7: xdat_user_login - active sessions
=========================================
Active session monitoring

psql:/tmp/test_schema_indexes.sql:270: ERROR:  argument of NOT must be type boolean, not type timestamp without time zone
LINE 1: ...ontainer_entity WHERE project = 'CMB-MML' AND NOT disabled O...
                                                             ^
QUERY:  SELECT * FROM xhbm_container_entity WHERE project = 'CMB-MML' AND NOT disabled ORDER BY created DESC LIMIT 50
CONTEXT:  PL/pgSQL function test_schema_index(text,text,text,text,text) line 22 at EXECUTE
SQL statement "SELECT *             FROM test_schema_index(
            'xhbm_container_entity',
            'project, created DESC',
            'idx_test_container_project',
            FORMAT('SELECT * FROM xhbm_container_entity WHERE project = %L AND NOT disabled ORDER BY created DESC LIMIT 50', sample_project),
            'NOT disabled'
        )"
PL/pgSQL function inline_code_block line 12 at SQL statement
psql:/tmp/test_schema_indexes.sql:294: NOTICE:  Baseline: 5.3670000000000000.2f ms
psql:/tmp/test_schema_indexes.sql:294: NOTICE:  Index created: idx_test_user_login_active
psql:/tmp/test_schema_indexes.sql:294: NOTICE:  With index: 4.7514000000000000.2f ms
psql:/tmp/test_schema_indexes.sql:294: NOTICE:  KEEP - improved by 11.47.2f%
DO
Time: 166.748 ms

=========================================
Test 8: xnat_resource - format
=========================================
Resource format filtering

psql:/tmp/test_schema_indexes.sql:318: NOTICE:  Baseline: 1.15300000000000000000.2f ms
psql:/tmp/test_schema_indexes.sql:318: NOTICE:  Index created: idx_test_resource_format
psql:/tmp/test_schema_indexes.sql:318: NOTICE:  With index: 0.22820000000000000000.2f ms
psql:/tmp/test_schema_indexes.sql:318: NOTICE:  KEEP - improved by 80.21.2f%
DO
Time: 64.095 ms

=========================================
Test 9: xnat_imagescandata - modality
=========================================
Scan modality filtering

psql:/tmp/test_schema_indexes.sql:342: NOTICE:  Baseline: 1.6838000000000000.2f ms
psql:/tmp/test_schema_indexes.sql:342: NOTICE:  Index created: idx_test_imagescan_modality
psql:/tmp/test_schema_indexes.sql:342: NOTICE:  With index: 0.62460000000000000000.2f ms
psql:/tmp/test_schema_indexes.sql:342: NOTICE:  KEEP - improved by 62.91.2f%
DO
Time: 70.405 ms

=========================================
Test 10: xnat_imagescandata - uid
=========================================
DICOM UID lookup

psql:/tmp/test_schema_indexes.sql:374: NOTICE:  Baseline: 1.04840000000000000000.2f ms
psql:/tmp/test_schema_indexes.sql:374: NOTICE:  Index created: idx_test_imagescan_uid
psql:/tmp/test_schema_indexes.sql:374: NOTICE:  With index: 0.55760000000000000000.2f ms
psql:/tmp/test_schema_indexes.sql:374: NOTICE:  KEEP - improved by 46.81.2f%
DO
Time: 81.926 ms

=========================================
SUMMARY
=========================================

 tables_tested | indexes_tested | kept | rolled_back | errors | avg_improvement_pct 
---------------+----------------+------+-------------+--------+---------------------
             6 |              7 |    7 |           0 |      0 |               65.78
(1 row)

Time: 2.194 ms

--- KEPT INDEXES (>= 5% improvement) ---
           table_name            |          index_name          |      columns       | improvement_pct 
---------------------------------+------------------------------+--------------------+-----------------
 xdat_change_info                | idx_test_change_info_date    | Schema-based index |           99.07
 xhbm_dicom_spatial_data         | idx_test_dicom_series        | Schema-based index |           87.17
 xnat_resource                   | idx_test_resource_format     | Schema-based index |           80.21
 xhbm_container_entity_log_paths | idx_test_log_paths_container | Schema-based index |           72.85
 xnat_imagescandata              | idx_test_imagescan_modality  | Schema-based index |           62.91
 xnat_imagescandata              | idx_test_imagescan_uid       | Schema-based index |           46.81
 xdat_user_login                 | idx_test_user_login_active   | Schema-based index |           11.47
(7 rows)

Time: 0.941 ms

--- ROLLED BACK (<5% improvement) ---
 table_name | index_name | columns | improvement_pct 
------------+------------+---------+-----------------
(0 rows)

Time: 0.545 ms
psql:/tmp/test_schema_indexes.sql:428: NOTICE:  Dropped: idx_test_change_info_date
psql:/tmp/test_schema_indexes.sql:428: NOTICE:  Dropped: idx_test_dicom_series
psql:/tmp/test_schema_indexes.sql:428: NOTICE:  Dropped: idx_test_imagescan_modality
psql:/tmp/test_schema_indexes.sql:428: NOTICE:  Dropped: idx_test_imagescan_uid
psql:/tmp/test_schema_indexes.sql:428: NOTICE:  Dropped: idx_test_log_paths_container
psql:/tmp/test_schema_indexes.sql:428: NOTICE:  Dropped: idx_test_resource_format
psql:/tmp/test_schema_indexes.sql:428: NOTICE:  Dropped: idx_test_user_login_active
DO
Time: 36.610 ms

All test indexes cleaned up
Results saved in pg_index_test_log table

