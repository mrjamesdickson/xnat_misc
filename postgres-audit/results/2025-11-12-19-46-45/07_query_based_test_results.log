Timing is on.

=========================================
Testing Query-Based Indexes
=========================================
Configuration:
  MAX_QUERIES:  100
  MIN_CALLS:  50
  MIN_AVG_TIME_MS:  0.5

psql:/tmp/test_query_based_indexes.sql:33: NOTICE:  relation "pg_index_test_log" already exists, skipping
CREATE TABLE
Time: 1.115 ms

--- Top Queries by Call Count ---
 calls | avg_ms | total_ms |                                  query_preview                                   
-------+--------+----------+----------------------------------------------------------------------------------
  1328 |   1.61 |  2131.91 | SELECT contents FROM xs_item_cache WHERE elementName=$1 AND ids=$2
   722 |   0.90 |   648.45 | select preference0_.id as id1_64_, preference0_.created as created2_64_, prefere
   160 |  72.48 | 11596.04 | SELECT *             FROM test_fk_index(                                        +
       |        |          |                 fk.table_name,                                                  +
       |        |          |         
    80 |   1.78 |   142.23 | SELECT COUNT(*) FROM xhbm_container_entity_output WHERE container_entity IS NOT 
    80 |   1.87 |   149.46 | SELECT COUNT(*) FROM xhbm_container_entity WHERE parent_container_entity IS NOT 
    80 |   2.62 |   209.83 | SELECT COUNT(*) FROM xhbm_container_entity_mount WHERE container_entity IS NOT N
    80 |   1.25 |    99.77 | SELECT COUNT(*) FROM xhbm_container_entity_log_paths WHERE container_entity IS N
    80 |   8.74 |   699.55 | SELECT COUNT(*) FROM xhbm_container_entity_history WHERE container_entity IS NOT
    80 |   0.55 |    43.86 | SELECT COUNT(*) FROM xhbm_timed_event_status_entity WHERE subscription_delivery_
    74 |   1.66 |   122.87 | SELECT i_wrk_workflowData($1,$2,$3,$4,$5)
    60 |   0.51 |    30.50 | SELECT * FROM xhbm_container_entity_log_paths WHERE container_entity = $1
    60 |   1.43 |    85.54 | SELECT session_id, ip_address FROM xdat_user_login WHERE session_id IN ($1,$2,$3
    60 |   2.75 |   165.25 | SELECT * FROM xhbm_dicom_spatial_data WHERE series_uid = $1 ORDER BY frame_numbe
    60 |   4.48 |   268.57 | SELECT * FROM xdat_user_login WHERE logout_date IS NULL ORDER BY login_date DESC
    60 |  23.76 |  1425.75 | SELECT * FROM xdat_change_info WHERE change_date > NOW() - INTERVAL $1 ORDER BY 
(15 rows)

Time: 9.373 ms

--- Top Queries by Total Time ---
 calls | avg_ms | total_ms |                                  query_preview                                   
-------+--------+----------+----------------------------------------------------------------------------------
   160 |  72.48 | 11596.04 | SELECT *             FROM test_fk_index(                                        +
       |        |          |                 fk.table_name,                                                  +
       |        |          |         
  1328 |   1.61 |  2131.91 | SELECT contents FROM xs_item_cache WHERE elementName=$1 AND ids=$2
    60 |  23.76 |  1425.75 | SELECT * FROM xdat_change_info WHERE change_date > NOW() - INTERVAL $1 ORDER BY 
    80 |   8.74 |   699.55 | SELECT COUNT(*) FROM xhbm_container_entity_history WHERE container_entity IS NOT
   722 |   0.90 |   648.45 | select preference0_.id as id1_64_, preference0_.created as created2_64_, prefere
    60 |   4.48 |   268.57 | SELECT * FROM xdat_user_login WHERE logout_date IS NULL ORDER BY login_date DESC
    80 |   2.62 |   209.83 | SELECT COUNT(*) FROM xhbm_container_entity_mount WHERE container_entity IS NOT N
    60 |   2.75 |   165.25 | SELECT * FROM xhbm_dicom_spatial_data WHERE series_uid = $1 ORDER BY frame_numbe
    80 |   1.87 |   149.46 | SELECT COUNT(*) FROM xhbm_container_entity WHERE parent_container_entity IS NOT 
    80 |   1.78 |   142.23 | SELECT COUNT(*) FROM xhbm_container_entity_output WHERE container_entity IS NOT 
    74 |   1.66 |   122.87 | SELECT i_wrk_workflowData($1,$2,$3,$4,$5)
    80 |   1.25 |    99.77 | SELECT COUNT(*) FROM xhbm_container_entity_log_paths WHERE container_entity IS N
    60 |   1.43 |    85.54 | SELECT session_id, ip_address FROM xdat_user_login WHERE session_id IN ($1,$2,$3
    80 |   0.55 |    43.86 | SELECT COUNT(*) FROM xhbm_timed_event_status_entity WHERE subscription_delivery_
    60 |   0.51 |    30.50 | SELECT * FROM xhbm_container_entity_log_paths WHERE container_entity = $1
(15 rows)

Time: 4.197 ms

=========================================
Testing Specific Query Patterns
=========================================

CREATE FUNCTION
Time: 5.797 ms
Test function created


=========================================
Test 1: xs_item_cache (elementName, ids)
=========================================
Query pattern: SELECT contents FROM xs_item_cache WHERE elementName=$1 AND ids=$2
Calls: 1,284 | Avg: 1.63ms

psql:/tmp/test_query_based_indexes.sql:189: NOTICE:  Baseline: 0.75500000000000000000.2f ms
psql:/tmp/test_query_based_indexes.sql:189: NOTICE:  Index created: idx_test_query_item_cache_element_ids(elementName, ids)
psql:/tmp/test_query_based_indexes.sql:189: NOTICE:  With index: 0.33500000000000000000.2f ms
psql:/tmp/test_query_based_indexes.sql:189: NOTICE:  KEEP - improved by 55.63.2f%
DO
Time: 46.592 ms

=========================================
Test 2: xnat_imagesessiondata_history
=========================================
Query pattern: WHERE id = $1 AND change_date IS NOT NULL
Calls: 1,107 | Avg: 0.09ms

psql:/tmp/test_query_based_indexes.sql:218: NOTICE:  Baseline: 0.48600000000000000000.2f ms
psql:/tmp/test_query_based_indexes.sql:218: NOTICE:  Index created: idx_test_query_imagesession_history(id, change_date)
psql:/tmp/test_query_based_indexes.sql:218: NOTICE:  With index: 0.50380000000000000000.2f ms
psql:/tmp/test_query_based_indexes.sql:218: NOTICE:  ROLLBACK - only improved by -3.66.2f%
DO
Time: 32.139 ms

=========================================
Test 3: xhbm_preference
=========================================
Query pattern: Complex WHERE clauses
Calls: 7,162 | Avg: 0.08ms

psql:/tmp/test_query_based_indexes.sql:247: NOTICE:  Baseline: 0.26820000000000000000.2f ms
psql:/tmp/test_query_based_indexes.sql:247: NOTICE:  Index created: idx_test_query_preference_tool_name(tool, name)
psql:/tmp/test_query_based_indexes.sql:247: NOTICE:  With index: 0.27720000000000000000.2f ms
psql:/tmp/test_query_based_indexes.sql:247: NOTICE:  ROLLBACK - only improved by -3.36.2f%
DO
Time: 21.206 ms

=========================================
Test 4: xdat_user_login (session_id)
=========================================
Query pattern: WHERE session_id IN (...)

psql:/tmp/test_query_based_indexes.sql:276: NOTICE:  Baseline: 3.0588000000000000.2f ms
psql:/tmp/test_query_based_indexes.sql:276: NOTICE:  Index created: idx_test_query_user_login_session(session_id)
psql:/tmp/test_query_based_indexes.sql:276: NOTICE:  With index: 0.41460000000000000000.2f ms
psql:/tmp/test_query_based_indexes.sql:276: NOTICE:  KEEP - improved by 86.45.2f%
DO
Time: 118.074 ms

=========================================
SUMMARY
=========================================

psql:/tmp/test_query_based_indexes.sql:296: ERROR:  column "tested_at" does not exist
LINE 9:   AND tested_at > NOW() - INTERVAL '1 hour';
              ^
Time: 1.644 ms

--- KEPT INDEXES (>= 5% improvement) ---
Time: 0.310 ms

Results saved in pg_index_test_log table

psql:/tmp/test_query_based_indexes.sql:308: ERROR:  column "tested_at" does not exist
LINE 8:   AND tested_at > NOW() - INTERVAL '1 hour'
              ^
